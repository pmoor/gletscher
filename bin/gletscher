#!/usr/bin/env python3

# Copyright 2012 Patrick Moor <patrick@moor.ws>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import argparse
from gletscher.commands.backup import backup_command
from gletscher.commands.download_catalog import download_catalog_command
from gletscher.commands.new import new_command
from gletscher.commands.repair import repair_command
from gletscher.commands.search_catalog import search_catalog_command
from gletscher.commands.upload_catalog import upload_catalog_command
from gletscher.commands.glacier_list_jobs import glacier_list_jobs_command
from gletscher.commands.glacier_retrieve_job_output import glacier_retrieve_job_output_command

parser = argparse.ArgumentParser(
    description="Tool for backing up files to Amazon's Glacier Service.")
subparsers = parser.add_subparsers(
    title="Supported gletscher.commands",
    description="Offers a variety of gletscher commands",
    help="such as these",
    dest="command")

# New Configuration
new_parser = subparsers.add_parser(
    "new", help="creates a new back-up configuration")
new_parser.add_argument(
    "-c", "--config", help="name of the configuration file to be created",
    required=True)
new_parser.set_defaults(fn=new_command)

# Backup
backup_parser = subparsers.add_parser(
    "backup", help="start backing-up some directories")
backup_parser.add_argument(
    "-c", "--config", help="config file for backup set", required=True)
backup_parser.add_argument(
    "--catalog", help="catalog name to use", required=False, default="default")
backup_parser.add_argument(
    "-a", "--add", action="store_true",
    help="add to, rather than replace, the existing catalog")
backup_parser.add_argument(
    "files", metavar="file", nargs="+",
    help="a set of files and directories to be backed-up")
backup_parser.set_defaults(fn=backup_command)

# Repair
repair_parser = subparsers.add_parser(
    "repair", help="repairs a broken index")
repair_parser.add_argument(
    "-c", "--config", help="name of the configuration file to be created",
    required=True)
repair_parser.set_defaults(fn=repair_command)

# Upload Catalog
upload_catalog_parser = subparsers.add_parser(
    "upload_catalog", help="uploads a catalog/index")
upload_catalog_parser.add_argument(
    "-c", "--config", help="configuration directory to use", required=True)
upload_catalog_parser.add_argument(
    "--catalog", help="catalog to upload", required=True, default="default")
upload_catalog_parser.set_defaults(fn=upload_catalog_command)

# Search Catalog
search_catalog_parser = subparsers.add_parser(
    "search_catalog", help="looks for files in a catalog")
search_catalog_parser.add_argument(
    "-c", "--config", help="configuration directory to use", required=True)
search_catalog_parser.add_argument(
    "--catalog", help="catalog to search", default="default")
search_catalog_parser.add_argument(
    "reg_exps", help="regular expressions to match against", nargs="+")
search_catalog_parser.set_defaults(fn=search_catalog_command)

# Download Catalog
download_catalog_parser = subparsers.add_parser(
    "download_catalog", help="downloads and merges a catalog/index from Glacier")
download_catalog_parser.add_argument(
    "-c", "--config", help="configuration directory to use", required=True)
download_catalog_parser.set_defaults(fn=download_catalog_command)

# List Jobs
glacier_list_jobs_parser = subparsers.add_parser(
    "glacier_list_jobs", help="listing of all glacier jobs")
glacier_list_jobs_parser.add_argument(
    "-c", "--config", help="configuration directory to use", required=True)
glacier_list_jobs_parser.set_defaults(fn=glacier_list_jobs_command)

# Retrieve Job Output
glacier_retrieve_job_output_parser = subparsers.add_parser(
    "glacier_retrieve_job_output", help="manually retrieves job output")
glacier_retrieve_job_output_parser.add_argument(
    "-c", "--config", help="configuration directory to use", required=True)
glacier_retrieve_job_output_parser.add_argument(
    "--job_id", help="JobId to fetch", required=True)
glacier_retrieve_job_output_parser.add_argument(
    "-o", "--output", help="file to store output in", required=True)
glacier_retrieve_job_output_parser.set_defaults(fn=glacier_retrieve_job_output_command)

args = parser.parse_args()
if not args.command:
    parser.error("no command specified")
args.fn(args)
#import cProfile
#cProfile.run('args.fn(args)', 'cprofile.out')
